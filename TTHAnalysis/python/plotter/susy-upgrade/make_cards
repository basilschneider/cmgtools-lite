#!/usr/bin/env bash

# Script to make data cards for Higgs Combine
# This needs to be called from $CMSSW_BASE/src/CMGTools/TTHAnalysis/python/plotter
# You need to have a symbolic link called "trees" pointing to your trees

# TODO: Speed this script up. Now it splits single jobs and runs them parallel,
# which most likely is not very efficient. Try not splitting single jobs, but
# running several of them in parallel. Or use HTCondor.

lumi=3000.

mca=susy-upgrade/mca_2LSOS.txt
systs=susy-upgrade/systs.txt
trees=trees/
dirBins=susy-upgrade/bins/binning_5met_4mll_3slep/
dirCards=susy-upgrade/cards/

# If cards directory exists, exit
if [ -d "${dirCards}" ]; then
    echo "Cards directory ${dirCards} exists already."
    echo "Exit."
    exit
fi

mkdir -p "${dirCards}"

signals=()
signals+=(N2C1_100_60_Delphes_14TeV)
signals+=(N2C1_100_65_Delphes_14TeV)
signals+=(N2C1_100_70_Delphes_14TeV)
signals+=(N2C1_100_75_Delphes_14TeV)
signals+=(N2C1_100_80_Delphes_14TeV)
signals+=(N2C1_100_85_Delphes_14TeV)
signals+=(N2C1_100_90_Delphes_14TeV)
signals+=(N2C1_100_93_Delphes_14TeV)
signals+=(N2C1_100_95_Delphes_14TeV)
signals+=(N2C1_150_110_Delphes_14TeV)
signals+=(N2C1_150_115_Delphes_14TeV)
signals+=(N2C1_150_120_Delphes_14TeV)
signals+=(N2C1_150_125_Delphes_14TeV)
signals+=(N2C1_150_130_Delphes_14TeV)
signals+=(N2C1_150_135_Delphes_14TeV)
signals+=(N2C1_150_140_Delphes_14TeV)
signals+=(N2C1_150_143_Delphes_14TeV)
signals+=(N2C1_150_145_Delphes_14TeV)
signals+=(N2C1_200_160_Delphes_14TeV)
signals+=(N2C1_200_165_Delphes_14TeV)
signals+=(N2C1_200_170_Delphes_14TeV)
signals+=(N2C1_200_175_Delphes_14TeV)
signals+=(N2C1_200_180_Delphes_14TeV)
signals+=(N2C1_200_185_Delphes_14TeV)
signals+=(N2C1_200_190_Delphes_14TeV)
signals+=(N2C1_200_193_Delphes_14TeV)
signals+=(N2C1_200_195_Delphes_14TeV)
signals+=(N2C1_250_210_Delphes_14TeV)
signals+=(N2C1_250_215_Delphes_14TeV)
signals+=(N2C1_250_220_Delphes_14TeV)
signals+=(N2C1_250_225_Delphes_14TeV)
signals+=(N2C1_250_230_Delphes_14TeV)
signals+=(N2C1_250_235_Delphes_14TeV)
signals+=(N2C1_250_240_Delphes_14TeV)
signals+=(N2C1_250_243_Delphes_14TeV)
signals+=(N2C1_250_245_Delphes_14TeV)
signals+=(N2C1_300_260_Delphes_14TeV)
signals+=(N2C1_300_265_Delphes_14TeV)
signals+=(N2C1_300_270_Delphes_14TeV)
signals+=(N2C1_300_275_Delphes_14TeV)
signals+=(N2C1_300_280_Delphes_14TeV)
signals+=(N2C1_300_285_Delphes_14TeV)
signals+=(N2C1_300_290_Delphes_14TeV)
signals+=(N2C1_300_293_Delphes_14TeV)
signals+=(N2C1_300_295_Delphes_14TeV)
signals+=(N2C1_350_310_Delphes_14TeV)
signals+=(N2C1_350_315_Delphes_14TeV)
signals+=(N2C1_350_320_Delphes_14TeV)
signals+=(N2C1_350_325_Delphes_14TeV)
signals+=(N2C1_350_330_Delphes_14TeV)
signals+=(N2C1_350_335_Delphes_14TeV)
signals+=(N2C1_350_340_Delphes_14TeV)
signals+=(N2C1_350_345_Delphes_14TeV)
signals+=(N2C1_400_360_Delphes_14TeV)
signals+=(N2C1_400_365_Delphes_14TeV)
signals+=(N2C1_400_370_Delphes_14TeV)
signals+=(N2C1_400_375_Delphes_14TeV)
signals+=(N2C1_400_380_Delphes_14TeV)
signals+=(N2C1_400_385_Delphes_14TeV)
signals+=(N2C1_400_390_Delphes_14TeV)
signals+=(N2C1_400_395_Delphes_14TeV)
signals+=(N2C1_450_410_Delphes_14TeV)
signals+=(N2C1_450_415_Delphes_14TeV)
signals+=(N2C1_450_420_Delphes_14TeV)
signals+=(N2C1_450_425_Delphes_14TeV)
signals+=(N2C1_450_430_Delphes_14TeV)
signals+=(N2C1_450_435_Delphes_14TeV)
signals+=(N2C1_450_440_Delphes_14TeV)
signals+=(N2C1_450_445_Delphes_14TeV)
signals+=(N2C1_500_460_Delphes_14TeV)
signals+=(N2C1_500_465_Delphes_14TeV)
signals+=(N2C1_500_470_Delphes_14TeV)
signals+=(N2C1_500_475_Delphes_14TeV)
signals+=(N2C1_500_480_Delphes_14TeV)
signals+=(N2C1_500_485_Delphes_14TeV)
signals+=(N2C1_500_490_Delphes_14TeV)
signals+=(N2C1_500_495_Delphes_14TeV)
signals+=(N2C1_550_510_Delphes_14TeV)
signals+=(N2C1_550_515_Delphes_14TeV)
signals+=(N2C1_550_520_Delphes_14TeV)
signals+=(N2C1_550_525_Delphes_14TeV)
signals+=(N2C1_550_530_Delphes_14TeV)
signals+=(N2C1_550_535_Delphes_14TeV)
signals+=(N2C1_550_540_Delphes_14TeV)
signals+=(N2C1_550_545_Delphes_14TeV)

for signal in "${signals[@]}"; do
    echo -n "Make datacards for signal point ${signal}... "
    for cuts in "${dirBins}"/*; do
        region="${cuts##*/}"
        region="${region%.*}"
        echo -n "${region}... "
        python makeCountingCards.py \
            <(sed "/${signal}/s/SkipMe *= *True/SkipMe=False/g" "${mca}") \
            "${cuts}" \
            "${systs}" \
            -P "${trees}" \
            -l "${lumi}" \
            -j 20 \
            --s2v \
            --tree treeProducerSusyUpgrade \
            --obj Delphes \
            --AP \
            -p Wj2,DY2,tt,WW,"${signal}" \
            > "${dirCards}"/"${signal}"_"${cuts##*/}"
    done
    echo "Done."
done
